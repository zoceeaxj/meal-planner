/* ============================
   Apps Script (Code.gs)
   Copy paste entire file
   ============================ */

const SHEET_ID = '1dXKOjcq99gZ51qrprHgjH5DAS2wt99bYcA0XWySKjRw';

/*
  IMPORTANT:
  1) Deploy as Web App
     - Execute as: Me
     - Who has access: Anyone
  2) Set APP_SECRET to a long random string.
  3) Put the same APP_SECRET in index.html.
*/
const APP_SECRET = 'CHANGE_ME_TO_A_LONG_RANDOM_SECRET';

function doGet(e) {
  // Simple health check in browser: .../exec?action=ping&secret=...
  return handle_(e);
}

function doPost(e) {
  return handle_(e);
}

function handle_(e) {
  try {
    const p = (e && e.parameter) ? e.parameter : {};
    const action = String(p.action || '').trim();

    // Basic gate (not perfect, but blocks random calls)
    const secret = String(p.secret || '').trim();
    if (!secret || secret !== APP_SECRET) {
      return json_({ ok: false, error: 'Unauthorized' }, 401);
    }

    const ss = SpreadsheetApp.openById(SHEET_ID);

    // ----------------------------
    // READ: Meals
    // ----------------------------
    if (action === 'getMeals') {
      const sheet = ss.getSheetByName('Meals');
      if (!sheet) throw new Error('Missing sheet: Meals');

      const values = sheet.getDataRange().getValues(); // includes header
      return json_({ ok: true, values });
    }

    // ----------------------------
    // READ: Checked groceries
    // ----------------------------
    if (action === 'getCheckedGroceries') {
      const sheet = ss.getSheetByName('CheckedGroceries');
      if (!sheet) throw new Error('Missing sheet: CheckedGroceries');

      const values = sheet.getDataRange().getValues(); // includes header
      const checked = values
        .slice(1)
        .map(r => String(r[0] || '').trim())
        .filter(Boolean);

      return json_({ ok: true, checked });
    }

    // ----------------------------
    // WRITE: Save meals
    // ----------------------------
    if (action === 'saveMeals') {
      const sheet = ss.getSheetByName('Meals');
      if (!sheet) throw new Error('Missing sheet: Meals');

      const meals = JSON.parse(p.meals || '[]');

      sheet.clearContents();
      sheet.getRange(1, 1, 1, 8).setValues([['ID','Name','Type','Start Date','End Date','Servings','Color','Groceries']]);

      const rows = meals.map(m => [
        m.id || Date.now(),
        m.name || '',
        m.type || 'lunch',
        m.startDate || '',
        m.endDate || '',
        Number(m.servings || 4),
        m.color || '',
        JSON.stringify(m.groceries || [])
      ]);

      if (rows.length) sheet.getRange(2, 1, rows.length, 8).setValues(rows);

      return json_({ ok: true });
    }

    // ----------------------------
    // WRITE: Save checked groceries
    // ----------------------------
    if (action === 'saveCheckedGroceries') {
      const sheet = ss.getSheetByName('CheckedGroceries');
      if (!sheet) throw new Error('Missing sheet: CheckedGroceries');

      const checked = JSON.parse(p.checked || '[]');

      sheet.clearContents();
      sheet.getRange(1, 1, 1, 1).setValues([['Checked Items']]);

      const rows = checked.map(x => [String(x)]);
      if (rows.length) sheet.getRange(2, 1, rows.length, 1).setValues(rows);

      return json_({ ok: true });
    }

    if (action === 'ping') {
      return json_({ ok: true, message: 'pong' });
    }

    return json_({ ok: false, error: 'Unknown action' }, 400);
  } catch (err) {
    return json_({ ok: false, error: String(err) }, 500);
  }
}

function json_(obj, code) {
  // Apps Script ignores custom status codes for ContentService in many cases.
  // We keep `code` param for readability and future use.
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

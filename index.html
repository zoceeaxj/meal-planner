<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>MealPlan Prototype</title>

  <style>
    /* -----------------------------
       GLOBAL RESET / BASE STYLES
       ----------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      padding: 10px;
      overflow-x: hidden;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
    }

    h1 {
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      font-size: 24px;
    }

    @media (min-width: 768px) {
      .container { padding: 30px; }
      h1 { font-size: 32px; margin-bottom: 20px; }
    }

    /* -----------------------------
       SYNC STATUS BANNER
       ----------------------------- */
    .sync-status {
      text-align: center;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-size: 13px;
      font-weight: 500;
    }
    .sync-status.synced  { background: #d4edda; color: #155724; }
    .sync-status.syncing { background: #fff3cd; color: #856404; }
    .sync-status.error   { background: #f8d7da; color: #721c24; }

    /* -----------------------------
       MAIN LAYOUT (CALENDAR + GROCERY)
       ----------------------------- */
    .main-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    @media (min-width: 768px) {
      .main-layout { flex-direction: row; }
    }

    .calendar-section { flex: 1; }

    .grocery-section {
      width: 100%;
      background: #fafafa;
      border-radius: 8px;
      padding: 15px;
      max-height: 500px;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .grocery-section {
        width: 350px;
        max-height: 800px;
        padding: 20px;
      }
    }

    /* -----------------------------
       TOP CONTROLS
       ----------------------------- */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    @media (min-width: 768px) {
      .controls {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }

    @media (min-width: 768px) {
      .month-nav { gap: 20px; }
    }

    .month-nav button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      touch-action: manipulation;
    }

    .month-nav button:active { background: #45a049; }

    .month-nav h2 {
      color: #333;
      font-size: 18px;
      flex: 1;
      text-align: center;
    }

    @media (min-width: 768px) {
      .month-nav h2 { font-size: 24px; min-width: 200px; }
    }

    .add-meal-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      width: 100%;
      touch-action: manipulation;
    }

    @media (min-width: 768px) { .add-meal-btn { width: auto; } }
    .add-meal-btn:active { background: #0b7dda; }

    /* -----------------------------
       CALENDAR GRID
       ----------------------------- */
    .calendar {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;

      /* mobile horizontal scroll */
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .calendar-day,
    .calendar-header > div {
      min-width: 0;
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, minmax(60px, 1fr));
      width: max(100%, 420px);
      background: #4CAF50;
      color: white;
    }

    .calendar-header div {
      padding: 10px 5px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }

    @media (min-width: 768px) {
      .calendar-header div { padding: 15px; font-size: 14px; }
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(60px, 1fr));
      width: max(100%, 420px);
    }

    .calendar-day {
      border: 1px solid #e0e0e0;
      min-height: 80px;
      padding: 5px;
      background: white;
      cursor: pointer;
      transition: background 0.2s;
      touch-action: manipulation;
    }

    @media (min-width: 768px) {
      .calendar-day { min-height: 120px; padding: 8px; }
    }

    .calendar-day:active { background: #f9f9f9; }

    .calendar-day.other-month {
      background: #fafafa;
      color: #999;
    }

    .day-number {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
      font-size: 12px;
    }

    @media (min-width: 768px) {
      .day-number { font-size: 14px; margin-bottom: 8px; }
    }

    /* -----------------------------
       MEAL PILLS
       ----------------------------- */
    .meal-item {
      font-size: 10px;
      padding: 3px 5px;
      margin: 2px 0;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      touch-action: manipulation;

      /* IMPORTANT: enables the inset status line */
      position: relative;
    }

    @media (max-width: 420px) {
      .meal-item {
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        line-height: 1.2;
        padding: 4px 6px;
        word-break: break-word;
      }
    }

    .meal-item:active { opacity: 0.8; }
    .meal-lunch::before { content: "üçΩÔ∏è "; }
    .meal-dinner::before { content: "üåô "; }

    /* Inset status line inside the meal pill
       - green means ready to cook
       - red means shopping required (unchecked items exist)
    */
    .meal-status-line {
      position: absolute;
      left: 10%;
      right: 10%;
      top: 50%;
      height: 3px;
      border-radius: 999px;
      transform: translateY(-50%);
      background: #2ecc71;
      opacity: 0.95;
      pointer-events: none;
    }

    .meal-status-line.red {
      background: #e74c3c;
    }

    /* -----------------------------
       GROCERY LIST UI
       ----------------------------- */
    .grocery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .grocery-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .grocery-item {
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .grocery-item.checked {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .grocery-checkbox {
      width: 22px;
      height: 22px;
      cursor: pointer;
      margin-right: 12px;
      flex-shrink: 0;
      touch-action: manipulation;
    }

    .grocery-content {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .grocery-item-name { flex: 1; }

    .grocery-item-quantity {
      background: rgba(255,255,255,0.3);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }

    /* Checked items collapsible section */
    .checked-section {
      margin-top: 12px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 8px 10px;
    }

    .checked-section summary {
      cursor: pointer;
      font-weight: 600;
      color: #333;
      list-style: none;
    }

    .checked-section summary::-webkit-details-marker { display: none; }
    #checkedGroceryList .grocery-item { margin-top: 8px; }

    /* -----------------------------
       MODAL
       ----------------------------- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      width: calc(100% - 40px);
      max-width: 600px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .modal-content {
        margin: 50px auto;
        padding: 30px;
        width: 90%;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #333;
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 40px;
      height: 40px;
      line-height: 32px;
      touch-action: manipulation;
    }

    .close-btn:active { color: #333; }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .date-range-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .color-picker-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-picker-group input[type="color"] {
      width: 60px;
      height: 40px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .grocery-inputs {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background: #fafafa;
    }

    .grocery-inputs h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 16px;
    }

    .grocery-input-row {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 420px) {
      .grocery-input-row {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "item qty"
          "remove remove";
        gap: 8px;
      }
      .grocery-input-row input:nth-child(1) { grid-area: item; }
      .grocery-input-row input:nth-child(2) { grid-area: qty; }
      .grocery-input-row .remove-grocery-btn { grid-area: remove; width: 100%; }
    }

    @media (max-width: 420px) {
      .calendar { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .calendar-header, .calendar-grid { min-width: 420px; }
    }

    .grocery-input-row input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      min-width: 0;
    }

    .remove-grocery-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 12px;
      border-radius: 5px;
      cursor: pointer;
      touch-action: manipulation;
    }

    .remove-grocery-btn:active { background: #da190b; }

    .add-grocery-input-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      touch-action: manipulation;
    }

    .add-grocery-input-btn:active { background: #45a049; }

    .form-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 25px;
    }

    @media (min-width: 768px) {
      .form-actions { flex-direction: row; }
    }

    .form-actions button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      touch-action: manipulation;
    }

    .save-btn { background: #4CAF50; color: white; }
    .save-btn:active { background: #45a049; }

    .cancel-btn { background: #f44336; color: white; }
    .cancel-btn:active { background: #da190b; }

    .delete-btn { background: #ff9800; color: white; }
    .delete-btn:active { background: #e68900; }

    /* -----------------------------
       LOADING OVERLAY
       ----------------------------- */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-overlay.show { display: flex; }

    .loading-spinner {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <!-- Loading overlay shown while syncing -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <div>Syncing with Google Sheets...</div>
    </div>
  </div>

  <div class="container">
    <h1>üçΩÔ∏è Monthly Meal Planner</h1>

    <!-- Sync status banner -->
    <div class="sync-status" id="syncStatus">
      <span id="syncStatusText">Connecting to Google Sheets...</span>
    </div>

    <div class="main-layout">
      <!-- CALENDAR -->
      <div class="calendar-section">
        <div class="controls">
          <div class="month-nav">
            <button onclick="previousMonth()">‚Üê Prev</button>
            <h2 id="currentMonth"></h2>
            <button onclick="nextMonth()">Next ‚Üí</button>
          </div>
          <button class="add-meal-btn" onclick="openAddMealModal()">+ Add Meal</button>
        </div>

        <div class="calendar">
          <div class="calendar-header">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>

      <!-- GROCERY LIST -->
      <div class="grocery-section">
        <div class="grocery-header">
          <h2>üìù Grocery List</h2>
        </div>

        <div id="groceryList"></div>

        <details class="checked-section" id="checkedSection">
          <summary id="checkedSummary">Checked items (0)</summary>
          <div id="checkedGroceryList"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- ADD / EDIT MEAL MODAL -->
  <div id="mealModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Meal</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>

      <div class="form-group">
        <label for="mealName">Meal Name</label>
        <input type="text" id="mealName" placeholder="Enter meal name" />
      </div>

      <div class="form-group">
        <label for="mealType">Meal Type</label>
        <select id="mealType">
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
        </select>
      </div>

      <div class="form-group">
        <label>Date Range</label>
        <div class="date-range-group">
          <div>
            <label for="startDate" style="font-weight: normal; font-size: 12px; color: #666;">Start Date</label>
            <input type="date" id="startDate" />
          </div>
          <div>
            <label for="endDate" style="font-weight: normal; font-size: 12px; color: #666;">End Date</label>
            <input type="date" id="endDate" />
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="servings">Number of Servings</label>
        <input type="number" id="servings" min="1" value="4" placeholder="Enter servings" />
      </div>

      <div class="form-group">
        <label>Color (optional)</label>
        <div class="color-picker-group">
          <input type="color" id="mealColor" value="#FF6B6B" />
          <span style="color:#666; font-size: 12px;">Auto-picked. Tap to change.</span>
        </div>
      </div>

      <div class="grocery-inputs">
        <h3>Grocery Items</h3>
        <div id="groceryInputs"></div>
        <button class="add-grocery-input-btn" onclick="addGroceryInput()">+ Add Grocery Item</button>
      </div>

      <div class="form-actions">
        <button class="save-btn" onclick="saveMeal()">Save Meal</button>
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
        <button class="delete-btn" id="deleteMealBtn" style="display: none;" onclick="deleteMeal()">Delete Meal</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       CONFIG
       ========================================================= */

    // Google Sheets read settings
    const SHEET_ID = '1dXKOjcq99gZ51qrprHgjH5DAS2wt99bYcA0XWySKjRw';
    const API_KEY = 'AIzaSyCe4wU0KYBY04Le9MAC4BaAuU1c-zy9dac';
    const MEALS_RANGE = 'Meals!A:H';
    const CHECKED_RANGE = 'CheckedGroceries!A:A';

    // Apps Script Web App URL (used for writing to Sheets)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyL8xy5VlkGcnyvedn6CaZbOKoB9wVTh-dpgL1C0m1tD3_psp44LAzwAF_ASW_Wm0v2/exec';

    /* =========================================================
       APP STATE
       ========================================================= */
    let currentDate = new Date();       // which month is being displayed
    let meals = [];                     // array of meal objects loaded from Sheets (or localStorage fallback)
    let editingMealId = null;           // if not null, the modal is editing an existing meal
    let selectedDate = null;            // date clicked on calendar (used for prefilling modal)
    let checkedGroceries = new Set();   // set of grocery keys that are checked: `${meal.id}-${grocery.item}`
    let isOnline = navigator.onLine;

    /* =========================================================
       UTILITIES
       ========================================================= */

    // Pick a color from palette (tries to avoid reusing already-used colors)
    function getNextAvailableColor() {
      const palette = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'];
      const used = new Set(meals.map(m => m.color).filter(Boolean));
      const available = palette.filter(c => !used.has(c));
      const pickFrom = available.length ? available : palette;
      return pickFrom[Math.floor(Math.random() * pickFrom.length)];
    }

    // Update the sync banner at the top
    function updateSyncStatus(status, message) {
      const statusEl = document.getElementById('syncStatus');
      const textEl = document.getElementById('syncStatusText');
      statusEl.className = 'sync-status ' + status;
      textEl.textContent = message;
    }

    // Show/hide the loading overlay
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (show) overlay.classList.add('show');
      else overlay.classList.remove('show');
    }

    // Check if date is within [startDate, endDate]
    function isDateInRange(date, startDate, endDate) {
      return date >= startDate && date <= endDate;
    }

    /* =========================================================
       READY-TO-COOK LOGIC (GREEN vs RED LINE)
       ========================================================= */

    // Rule:
    // - If meal has NO groceries => ready (green)
    // - If meal has groceries and ALL are checked => ready (green)
    // - Otherwise => not ready (red)
    function isMealReadyToCook(meal) {
      const items = meal?.groceries || [];
      if (items.length === 0) return true;
      return items.every(g => checkedGroceries.has(`${meal.id}-${g.item}`));
    }

    /* =========================================================
       LOCAL STORAGE BACKUP (fallback if Sheets fails)
       ========================================================= */
    function saveMealsToLocalStorage() {
      localStorage.setItem('mealPlanner', JSON.stringify(meals));
    }

    function loadMealsFromLocalStorage() {
      const stored = localStorage.getItem('mealPlanner');
      if (stored) meals = JSON.parse(stored);
    }

    function saveCheckedGroceriesToLocalStorage() {
      localStorage.setItem('checkedGroceries', JSON.stringify(Array.from(checkedGroceries)));
    }

    function loadCheckedGroceriesFromLocalStorage() {
      const stored = localStorage.getItem('checkedGroceries');
      if (stored) checkedGroceries = new Set(JSON.parse(stored));
    }

    /* =========================================================
       GOOGLE SHEETS: LOAD
       ========================================================= */

    // Read meals from Sheets (Meals!A:H)
    async function loadMealsFromSheets() {
      try {
        showLoading(true);
        updateSyncStatus('syncing', 'Loading meals from Google Sheets...');

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${MEALS_RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();

        // Expecting header row, then data rows
        if (data.values && data.values.length > 1) {
          meals = data.values.slice(1).map(row => ({
            id: parseInt(row[0]) || Date.now(),
            name: row[1] || '',
            type: row[2] || 'lunch',
            startDate: row[3] || '',
            endDate: row[4] || '',
            servings: parseInt(row[5]) || 4,
            color: row[6] || '#FF6B6B',
            groceries: row[7] ? JSON.parse(row[7]) : []
          }));
        } else {
          meals = [];
        }

        updateSyncStatus('synced', '‚úì Synced with Google Sheets');
        showLoading(false);
      } catch (error) {
        console.error('Error loading from Sheets:', error);
        updateSyncStatus('error', '‚úó Error loading data. Using local backup.');
        loadMealsFromLocalStorage();
        showLoading(false);
      }
    }

    // Read checked groceries from Sheets (CheckedGroceries!A:A)
    async function loadCheckedGroceriesFromSheets() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${CHECKED_RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.values && data.values.length > 0) {
          checkedGroceries = new Set(data.values.flat());
        } else {
          checkedGroceries = new Set();
        }
      } catch (error) {
        console.error('Error loading checked groceries:', error);
        loadCheckedGroceriesFromLocalStorage();
      }
    }

    /* =========================================================
       GOOGLE SHEETS: SAVE (via Apps Script Web App)
       ========================================================= */

    // Save meals by POSTing to Apps Script web app
    async function saveMealsToSheets() {
      try {
        updateSyncStatus('syncing', 'Saving...');

        if (!SCRIPT_URL) throw new Error('Missing SCRIPT_URL');

        // Use form-encoded POST to reduce CORS issues
        const body = new URLSearchParams();
        body.set('action', 'saveMeals');
        body.set('meals', JSON.stringify(meals));

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: body.toString()
        });

        const text = await res.text();
        let out = {};
        try { out = JSON.parse(text); } catch (_) {}

        if (!res.ok || out.ok === false) throw new Error(out.error || text || 'Apps Script save failed');

        saveMealsToLocalStorage();
        updateSyncStatus('synced', '‚úì Saved to Google Sheets');
      } catch (error) {
        console.error('Error saving to Sheets:', error);
        updateSyncStatus('error', '‚úó Not saved to Google Sheets. Saved locally.');
        saveMealsToLocalStorage();
      }
    }

    // Save checked grocery keys by POSTing to Apps Script web app
    async function saveCheckedGroceriesToSheets() {
      try {
        if (!SCRIPT_URL) {
          saveCheckedGroceriesToLocalStorage();
          return;
        }

        const body = new URLSearchParams();
        body.set('action', 'saveCheckedGroceries');
        body.set('checked', JSON.stringify(Array.from(checkedGroceries)));

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: body.toString()
        });

        const text = await res.text();
        let out = {};
        try { out = JSON.parse(text); } catch (_) {}

        if (!res.ok || out.ok === false) throw new Error(out.error || text || 'Apps Script save failed');

        saveCheckedGroceriesToLocalStorage();
      } catch (error) {
        console.error('Error saving checked groceries:', error);
        saveCheckedGroceriesToLocalStorage();
      }
    }

    /* =========================================================
       CALENDAR RENDERING
       ========================================================= */

    // Build the month grid UI
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      // Month title
      document.getElementById('currentMonth').textContent =
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const calendarGrid = document.getElementById('calendarGrid');
      calendarGrid.innerHTML = '';

      // Blank cells before the 1st of the month
      for (let i = 0; i < firstDay; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDiv);
      }

      // Actual day cells
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createDayCell(day, false, year, month);
        calendarGrid.appendChild(dayDiv);
      }

      // Fill remaining cells so grid stays aligned
      const totalCells = calendarGrid.children.length;
      const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
      for (let i = 0; i < remainingCells; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDiv);
      }
    }

    // Create one day cell (date number + meal pills)
    function createDayCell(day, isOtherMonth, year, month) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day' + (isOtherMonth ? ' other-month' : '');

      if (isOtherMonth) return dayDiv;

      // YYYY-MM-DD used everywhere for date comparisons
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      dayDiv.innerHTML = `<div class="day-number">${day}</div>`;

      // Get meals that overlap this date and sort lunch before dinner
      const dayMeals = meals
        .filter(meal => isDateInRange(dateStr, meal.startDate, meal.endDate))
        .sort((a, b) => {
          const order = { lunch: 1, dinner: 2 };
          return (order[a.type] ?? 99) - (order[b.type] ?? 99);
        });

      // Render each meal pill
      dayMeals.forEach(meal => {
        const mealDiv = document.createElement('div');
        mealDiv.className = `meal-item meal-${meal.type}`;
        mealDiv.style.background = meal.color;
        mealDiv.textContent = meal.name;

        // Insert the status line INSIDE the pill
        // green = ready, red = needs shopping
        const ready = isMealReadyToCook(meal);
        const line = document.createElement('div');
        line.className = 'meal-status-line' + (ready ? '' : ' red');
        mealDiv.appendChild(line);

        // Clicking a meal pill opens edit modal
        mealDiv.onclick = (e) => {
          e.stopPropagation();
          editMeal(meal.id);
        };

        dayDiv.appendChild(mealDiv);
      });

      // Clicking the blank part of the day cell opens "Add Meal" modal for that date
      dayDiv.onclick = () => openAddMealModal(dateStr);

      return dayDiv;
    }

    /* =========================================================
       MEAL MODAL (ADD / EDIT)
       ========================================================= */

    // Open modal for new meal
    function openAddMealModal(date = null) {
      document.getElementById('mealModal').style.display = 'block';
      document.getElementById('modalTitle').textContent = 'Add Meal';
      document.getElementById('deleteMealBtn').style.display = 'none';

      // Reset fields
      document.getElementById('mealName').value = '';
      document.getElementById('mealType').value = 'lunch';
      document.getElementById('servings').value = '4';
      document.getElementById('mealColor').value = getNextAvailableColor();

      // Default date range
      if (date) {
        document.getElementById('startDate').value = date;
        document.getElementById('endDate').value = date;
        selectedDate = date;
      } else {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        selectedDate = null;
      }

      // Reset grocery inputs (start with one row)
      document.getElementById('groceryInputs').innerHTML = '';
      addGroceryInput();

      editingMealId = null;
    }

    // Open modal for existing meal
    function editMeal(mealId) {
      const meal = meals.find(m => m.id === mealId);
      if (!meal) return;

      document.getElementById('mealModal').style.display = 'block';
      document.getElementById('modalTitle').textContent = 'Edit Meal';
      document.getElementById('deleteMealBtn').style.display = 'block';

      // Fill fields
      document.getElementById('mealName').value = meal.name;
      document.getElementById('mealType').value = meal.type;
      document.getElementById('startDate').value = meal.startDate;
      document.getElementById('endDate').value = meal.endDate;
      document.getElementById('servings').value = meal.servings;
      document.getElementById('mealColor').value = meal.color;

      // Fill groceries
      document.getElementById('groceryInputs').innerHTML = '';
      if (meal.groceries && meal.groceries.length > 0) {
        meal.groceries.forEach(g => addGroceryInput(g.item, g.quantity));
      } else {
        addGroceryInput();
      }

      editingMealId = mealId;
    }

    // Add a grocery input row in the modal
    function addGroceryInput(itemValue = '', quantityValue = '') {
      const container = document.getElementById('groceryInputs');
      const row = document.createElement('div');
      row.className = 'grocery-input-row';

      row.innerHTML = `
        <input type="text" placeholder="Grocery item" value="${itemValue}">
        <input type="text" placeholder="Quantity" value="${quantityValue}">
        <button class="remove-grocery-btn" onclick="removeGroceryInput(this)">‚úï</button>
      `;

      container.appendChild(row);
    }

    // Remove one grocery input row (but keep at least 1)
    function removeGroceryInput(btn) {
      const container = document.getElementById('groceryInputs');
      if (container.children.length > 1) btn.parentElement.remove();
    }

    // Save meal from modal into `meals[]`, then persist to Sheets
    async function saveMeal() {
      const name = document.getElementById('mealName').value.trim();
      const type = document.getElementById('mealType').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const servings = parseInt(document.getElementById('servings').value) || 4;
      const color = document.getElementById('mealColor').value;

      if (!name || !startDate || !endDate) {
        alert('Please fill in all required fields');
        return;
      }

      if (startDate > endDate) {
        alert('End date must be after start date');
        return;
      }

      // Read groceries from modal inputs
      const groceryRows = document.querySelectorAll('.grocery-input-row');
      const groceries = [];
      groceryRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const item = inputs[0].value.trim();
        const quantity = inputs[1].value.trim();
        if (item) groceries.push({ item, quantity });
      });

      // Build meal object
      const meal = {
        id: editingMealId || Date.now(),
        name,
        type,
        startDate,
        endDate,
        servings,
        color,
        groceries
      };

      // Insert or update in meals array
      if (editingMealId) {
        const index = meals.findIndex(m => m.id === editingMealId);
        meals[index] = meal;
      } else {
        meals.push(meal);
      }

      await saveMealsToSheets();
      closeModal();

      // Re-render calendar + grocery list (and lines)
      renderCalendar();
      renderGroceryList();
    }

    // Delete an existing meal
    async function deleteMeal() {
      if (!confirm('Are you sure you want to delete this meal?')) return;

      meals = meals.filter(m => m.id !== editingMealId);
      await saveMealsToSheets();
      closeModal();
      renderCalendar();
      renderGroceryList();
    }

    // Close modal and reset edit state
    function closeModal() {
      document.getElementById('mealModal').style.display = 'none';
      editingMealId = null;
      selectedDate = null;
    }

    // Click outside modal content closes it
    window.onclick = function(event) {
      const modal = document.getElementById('mealModal');
      if (event.target === modal) closeModal();
    };

    /* =========================================================
       GROCERY LIST RENDERING
       ========================================================= */

    // Create the grocery list for the CURRENT month, then split into unchecked + checked dropdown
    function renderGroceryList() {
      const groceryContainer = document.getElementById('groceryList');
      const checkedContainer = document.getElementById('checkedGroceryList');
      const checkedSection = document.getElementById('checkedSection');
      const checkedSummary = document.getElementById('checkedSummary');

      groceryContainer.innerHTML = '';
      checkedContainer.innerHTML = '';

      // Determine current month boundaries (YYYY-MM-01 to YYYY-MM-lastDay)
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthStart = `${year}-${String(month + 1).padStart(2, '0')}-01`;
      const monthEnd = `${year}-${String(month + 1).padStart(2, '0')}-${new Date(year, month + 1, 0).getDate()}`;

      // Map: groceryKey -> grocery display info
      // key format: `${meal.id}-${grocery.item}`
      const groceryMap = new Map();

      // Aggregate groceries from all meals that overlap current month
      meals.forEach(meal => {
        const mealOverlapsMonth = !(meal.endDate < monthStart || meal.startDate > monthEnd);

        if (mealOverlapsMonth && meal.groceries && meal.groceries.length > 0) {
          meal.groceries.forEach(grocery => {
            const key = `${meal.id}-${grocery.item}`;
            groceryMap.set(key, {
              item: grocery.item,
              quantity: grocery.quantity,
              color: meal.color,
              mealName: meal.name,
              key
            });
          });
        }
      });

      // If no groceries for month
      if (groceryMap.size === 0) {
        groceryContainer.innerHTML =
          '<p style="color: #999; text-align: center; padding: 20px;">No grocery items yet</p>';
        checkedSection.style.display = 'none';
        return;
      }

      let checkedCount = 0;
      let uncheckedCount = 0;

      // Helper to build a grocery row div
      function makeGroceryDiv(grocery, isChecked) {
        const groceryDiv = document.createElement('div');
        groceryDiv.className = 'grocery-item' + (isChecked ? ' checked' : '');
        groceryDiv.style.background = grocery.color;

        groceryDiv.innerHTML = `
          <div class="grocery-content">
            <input type="checkbox"
                   class="grocery-checkbox"
                   ${isChecked ? 'checked' : ''}
                   onchange="toggleGroceryCheck('${grocery.key}')">
            <div class="grocery-item-name">
              <div style="font-size: 13px; font-weight: 600;">${grocery.item}</div>
              <div style="font-size: 11px; opacity: 0.9; margin-top: 2px;">${grocery.mealName}</div>
            </div>
          </div>
          ${grocery.quantity ? `<div class="grocery-item-quantity">${grocery.quantity}</div>` : ''}
        `;

        return groceryDiv;
      }

      // First render unchecked groceries into main list
      groceryMap.forEach(grocery => {
        const isChecked = checkedGroceries.has(grocery.key);
        if (!isChecked) {
          uncheckedCount++;
          groceryContainer.appendChild(makeGroceryDiv(grocery, false));
        }
      });

      // Then render checked groceries into dropdown list
      groceryMap.forEach(grocery => {
        const isChecked = checkedGroceries.has(grocery.key);
        if (isChecked) {
          checkedCount++;
          checkedContainer.appendChild(makeGroceryDiv(grocery, true));
        }
      });

      // Update checked summary label + show/hide section
      checkedSummary.textContent = `Checked items (${checkedCount})`;
      checkedSection.style.display = checkedCount > 0 ? 'block' : 'none';

      // If everything is checked, show a friendly message in the main list
      if (uncheckedCount === 0 && checkedCount > 0) {
        groceryContainer.innerHTML =
          '<p style="color: #999; text-align: center; padding: 12px;">All items are checked.</p>';
      }
    }

    // Toggle a grocery key in the checkedGroceries set, persist it, then re-render UI
    async function toggleGroceryCheck(key) {
      if (checkedGroceries.has(key)) checkedGroceries.delete(key);
      else checkedGroceries.add(key);

      await saveCheckedGroceriesToSheets();

      // Re-render grocery list AND calendar so meal lines update immediately
      renderGroceryList();
      renderCalendar();
    }

    /* =========================================================
       MONTH NAVIGATION
       ========================================================= */

    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
      renderGroceryList();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
      renderGroceryList();
    }

    /* =========================================================
       ONLINE / OFFLINE HANDLING
       ========================================================= */

    window.addEventListener('online', async () => {
      isOnline = true;
      updateSyncStatus('syncing', 'Back online. Syncing...');
      await loadMealsFromSheets();
      await loadCheckedGroceriesFromSheets();
      renderCalendar();
      renderGroceryList();
      updateSyncStatus('synced', '‚úì Synced with Google Sheets');
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateSyncStatus('error', '‚úó Offline. Changes saved locally.');
    });

    /* =========================================================
       INIT
       ========================================================= */

    async function init() {
      await loadMealsFromSheets();
      await loadCheckedGroceriesFromSheets();
      renderCalendar();
      renderGroceryList();
    }

    init();
  </script>
</body>
</html>
